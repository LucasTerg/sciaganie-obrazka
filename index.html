<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automatyczne Kadrowanie Obrazu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Dodatkowe style dla lepszego wyglądu spinnera */
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-2xl bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 md:p-8">
        <h1 class="text-2xl md:text-3xl font-bold text-center mb-2 text-gray-800 dark:text-white">Automatyczne Kadrowanie Obrazu</h1>
        <p class="text-center text-gray-600 dark:text-gray-400 mb-6">Wklej link lub kliknij "Przetwórz", aby użyć linku ze schowka.</p>

        <!-- Pole do wklejania linku -->
        <div class="flex flex-col sm:flex-row gap-3 mb-4">
            <input type="url" id="imageUrl" placeholder="Wklej link lub pozostaw puste..." class="flex-grow bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
            <button id="processBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-6 rounded-lg transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                Przetwórz
            </button>
        </div>

        <!-- Komunikaty i spinner -->
        <div id="status" class="text-center my-4 min-h-[24px]"></div>
        <div id="loader" class="hidden loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mx-auto mb-4"></div>

        <!-- Podgląd obrazów -->
        <div id="previewContainer" class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6 hidden">
            <div>
                <h3 class="text-lg font-semibold mb-2 text-center">Oryginał</h3>
                <div class="bg-gray-200 dark:bg-gray-700 rounded-lg overflow-hidden p-2">
                     <img id="originalImage" src="" alt="Oryginalny obraz" class="w-full h-auto rounded-md object-contain max-h-64">
                </div>
            </div>
            <div>
                <h3 class="text-lg font-semibold mb-2 text-center">Wynik</h3>
                <div class="bg-gray-200 dark:bg-gray-700 rounded-lg overflow-hidden p-2">
                    <canvas id="resultCanvas" class="w-full h-auto rounded-md object-contain max-h-64"></canvas>
                </div>
            </div>
        </div>

        <!-- Przycisk pobierania -->
        <div class="text-center mt-6">
            <a id="downloadBtn" class="hidden bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50" download="obraz_przyciety.jpg">
                Pobierz Wynik (JPG)
            </a>
        </div>
    </div>

    <script>
        // Elementy DOM
        const imageUrlInput = document.getElementById('imageUrl');
        const processBtn = document.getElementById('processBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const statusDiv = document.getElementById('status');
        const loader = document.getElementById('loader');
        const previewContainer = document.getElementById('previewContainer');
        const originalImageElem = document.getElementById('originalImage');
        const resultCanvas = document.getElementById('resultCanvas');

        // Event Listener
        processBtn.addEventListener('click', handleImageProcessing);

        async function handleImageProcessing() {
            let imageUrl = imageUrlInput.value.trim();

            // POPRAWKA: Jeśli pole jest puste, spróbuj wkleić ze schowka
            if (!imageUrl) {
                try {
                    if (navigator.clipboard && typeof navigator.clipboard.readText === 'function') {
                        const text = await navigator.clipboard.readText();
                        if (text) {
                            imageUrlInput.value = text;
                            imageUrl = text; // Zaktualizuj zmienną
                            showStatus('Wklejono link ze schowka...', 'info');
                        }
                    }
                } catch (err) {
                    console.error('Nie udało się odczytać schowka (prawdopodobnie brak zgody):', err);
                }
            }

            // Sprawdź ponownie, czy mamy URL
            if (!imageUrl) {
                showStatus('Pole jest puste. Wklej link lub skopiuj go do schowka.', 'error');
                return;
            }

            // Reset UI
            statusDiv.textContent = '';
            loader.classList.remove('hidden');
            previewContainer.classList.add('hidden');
            downloadBtn.classList.add('hidden');

            try {
                const proxyUrl = 'https://corsproxy.io/?';
                const response = await fetch(proxyUrl + encodeURIComponent(imageUrl));

                if (!response.ok) {
                    throw new Error(`Błąd sieci: ${response.statusText}`);
                }

                const blob = await response.blob();
                const objectURL = URL.createObjectURL(blob);

                const img = new Image();
                img.onload = () => {
                    originalImageElem.src = objectURL;
                    trimImage(img);
                    loader.classList.add('hidden');
                    previewContainer.classList.remove('hidden');
                    downloadBtn.classList.remove('hidden');
                };
                img.onerror = () => {
                    showStatus('Nie można załadować obrazu. Sprawdź link lub spróbuj inny.', 'error');
                    loader.classList.add('hidden');
                    URL.revokeObjectURL(objectURL);
                };
                img.src = objectURL;

            } catch (error) {
                console.error('Błąd przetwarzania:', error);
                showStatus(`Wystąpił błąd: ${error.message}. Spróbuj użyć innego obrazu lub proxy.`, 'error');
                loader.classList.add('hidden');
            }
        }

        function trimImage(img) {
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = img.width;
            tempCanvas.height = img.height;
            tempCtx.drawImage(img, 0, 0);

            const data = tempCtx.getImageData(0, 0, img.width, img.height).data;
            const bg = [data[0], data[1], data[2]];
            
            let top = 0, bottom = img.height, left = 0, right = img.width;
            const tolerance = 5; 

            function isBgColor(i) {
                return Math.abs(data[i] - bg[0]) <= tolerance &&
                       Math.abs(data[i+1] - bg[1]) <= tolerance &&
                       Math.abs(data[i+2] - bg[2]) <= tolerance;
            }

            scanY: for (let y = 0; y < img.height; y++) {
                for (let x = 0; x < img.width; x++) {
                    if (!isBgColor((y * img.width + x) * 4)) { top = y; break scanY; }
                }
            }

            scanY2: for (let y = img.height - 1; y >= top; y--) {
                for (let x = 0; x < img.width; x++) {
                    if (!isBgColor((y * img.width + x) * 4)) { bottom = y; break scanY2; }
                }
            }

            scanX: for (let x = 0; x < img.width; x++) {
                for (let y = top; y <= bottom; y++) {
                    if (!isBgColor((y * img.width + x) * 4)) { left = x; break scanX; }
                }
            }

            scanX2: for (let x = img.width - 1; x >= left; x--) {
                for (let y = top; y <= bottom; y++) {
                    if (!isBgColor((y * img.width + x) * 4)) { right = x; break scanX2; }
                }
            }

            const trimWidth = right - left + 1;
            const trimHeight = bottom - top + 1;

            resultCanvas.width = trimWidth;
            resultCanvas.height = trimHeight;
            const resultCtx = resultCanvas.getContext('2d');

            // NOWA ZMIANA: Wypełnij tło na biało przed rysowaniem
            resultCtx.fillStyle = '#FFFFFF';
            resultCtx.fillRect(0, 0, trimWidth, trimHeight);

            resultCtx.drawImage(img, left, top, trimWidth, trimHeight, 0, 0, trimWidth, trimHeight);

            // NOWA ZMIANA: Zapisz jako JPG z jakością 90%
            downloadBtn.href = resultCanvas.toDataURL('image/jpeg', 0.9);
        }
        
        function showStatus(message, type = 'info') {
            statusDiv.textContent = message;
            statusDiv.className = 'text-center my-4 min-h-[24px]'; // Reset
            if (type === 'error') {
                statusDiv.classList.add('text-red-500');
            } else {
                statusDiv.classList.add('text-blue-500');
            }
        }
    </script>
</body>
</html>
